// Generated by CoffeeScript 1.6.2
var add_bars, add_state, bring_to_top, calculate_percentages, calculate_scores, change_green_val, chart_group, fill_color, get_chart_data, get_xScale, green_scale, height, make_chart, margins, pie_colors, red_scale, setup_chart, show_map, update_bars, width, _index, _max, _min, _percentages, _scores, _totals;

green_scale = d3.scale.linear().domain([0, 1]).range(['grey', 'green']);

red_scale = d3.scale.linear().domain([0, 1]).range(['grey', 'red']);

_scores = {};

_percentages = {};

_totals = {};

_max = 2012;

_min = 2001;

_index = 0;

margins = {
  top: 20,
  right: 20,
  bottom: 20,
  left: 20
};

width = 959;

height = 593;

pie_colors = {
  coal: "#000",
  pet_liquid: '#567880',
  pet_coke: '#624949',
  nat_gas: '#dee4fa',
  other_gases: '#81a3d0',
  nuclear: '#19d2b2',
  hydro: '#003b6f',
  other_renew: '#567880',
  wind: '#dee4fa',
  solar: '#feb718',
  wood: '#624949',
  geo: '#383838',
  biomass: '#8cb990',
  hydro_pumped: '#743466',
  other: '#9a679f'
};

chart_group = void 0;

calculate_scores = function(state) {
  var gigawatts, i, k, scores, state_data, toAdd, totals, v, _i, _ref;

  state_data = gon.elec_data[state];
  scores = [];
  totals = [];
  _max = 0;
  for (k in state_data) {
    v = state_data[k];
    if (typeof v !== typeof "") {
      if (v[0][0] > _max) {
        _max = v[0][0];
      }
      for (i = _i = 0, _ref = v.length; _i < _ref; i = _i += 1) {
        gigawatts = parseFloat(v[i][1]);
        if ($.isNumeric(gigawatts)) {
          if (gigawatts < 0) {

          } else {
            if (!$.isNumeric(scores[i])) {
              scores[i] = 0;
            }
            if (!$.isNumeric(totals[i])) {
              totals[i] = 0;
            }
            toAdd = gon.green[k] * gigawatts;
            scores[i] += toAdd;
            totals[i] += gigawatts;
          }
        }
      }
    }
  }
  _scores[state] = scores;
  return _totals[state] = totals;
};

calculate_percentages = function(state) {
  var i, k, percentage_series, percentages, state_data, totals, v, _i, _ref;

  state_data = gon.elec_data[state];
  totals = _totals[state];
  percentages = {};
  for (k in state_data) {
    v = state_data[k];
    if (typeof v !== typeof "") {
      percentage_series = [];
      for (i = _i = 0, _ref = v.length; _i < _ref; i = _i += 1) {
        percentage_series[i] = v[i][1] / totals[i] * 100;
      }
      percentages[k] = percentage_series;
    }
  }
  return _percentages[state] = percentages;
};

change_green_val = function(type, value) {
  var state, _i, _len, _ref, _results;

  $("#" + type).slider("value", value);
  $("#" + type + "_box").val(value);
  gon.green[type] = value;
  _ref = gon.state_abbrevs;
  _results = [];
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    state = _ref[_i];
    calculate_scores(state);
    _results.push(d3.select("#" + state).attr('fill', fill_color(state)));
  }
  return _results;
};

fill_color = function(state) {
  var color, scores, totals;

  scores = _scores[state];
  totals = _totals[state];
  if (scores[_index] > 0) {
    color = green_scale(scores[_index] / totals[_index]);
  } else {
    color = red_scale(-scores[_index] / totals[_index]);
  }
  return color;
};

bring_to_top = function(id_to_top) {
  d3.selectAll('path').datum(-1);
  d3.select('#veil').datum(-2);
  d3.select("#" + id_to_top).datum(1);
  d3.selectAll('path').sort().order();
  d3.select('#MI-').attr('fill', fill_color("MI"));
  return d3.select('#SP-').attr('fill', fill_color("MI"));
};

show_map = function() {
  d3.selectAll('rect').remove();
  return d3.selectAll('.axis').remove();
};

get_chart_data = function(state_id, absolute) {
  var labels, numbers, series, type, _ref, _ref1;

  labels = [];
  numbers = [];
  if (absolute) {
    _ref = gon.elec_data[state_id];
    for (type in _ref) {
      series = _ref[type];
      labels[labels.length] = type;
      numbers[numbers.length] = series[_index][1];
    }
  } else {
    _ref1 = _percentages[state_id];
    for (type in _ref1) {
      series = _ref1[type];
      labels[labels.length] = type;
      numbers[numbers.length] = series[_index];
    }
  }
  return [labels, numbers];
};

setup_chart = function() {
  return chart_group.append('rect').attr('id', 'veil').attr('width', '959').attr('height', '593').attr('fill', 'white').attr('opacity', '0.75');
};

add_state = function(state_id) {
  console.log('add state');
  return chart_group.append('g').attr('id', "" + state_id + "_bars").attr('transform', "translate: " + (width / 2) + ", " + (height / 2));
};

get_xScale = function(numbers) {
  console.log('get_xScale');
  return d3.scale.linear().domain([0, d3.sum(numbers)]).range([0, width - margins['left'] - margins['right']]);
};

add_bars = function(state_id) {
  var data, labels, numbers, xScale;

  console.log('add_bars');
  data = get_chart_data(state_id, false);
  labels = data[0];
  numbers = data[1];
  xScale = get_xScale(numbers);
  chart_group.append('g').call(d3.svg.axis().scale(xScale).orient('bottom')).attr('class', 'axis').attr('transform', "translate(" + margins['left'] + ", 0)");
  return d3.select("#" + state_id + "_bars").selectAll('rect').data(numbers).enter().append('rect').attr('y', function(d, i) {
    return 20 * i + 2 * margins['top'];
  }).attr('x', function(d, i) {
    return margins['left'];
  }).attr('height', 18).attr('width', function(d, i) {
    return xScale(d) || 0;
  }).attr('fill', function(d, i) {
    return pie_colors[labels[i]];
  }).attr('id', function(d, i) {
    return labels[i] + "_bar";
  });
};

update_bars = function() {
  return chart_group.selectAll('g').selectAll('rect');
};

make_chart = function(state_id) {
  console.log(state_id);
  console.log(chart_group);
  setup_chart();
  add_state(state_id);
  return add_bars(state_id);
};

$(function() {
  var abbrev, type, weight, _i, _len, _ref, _ref1;

  chart_group = d3.select("#chart_group");
  _ref = gon.state_abbrevs;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    abbrev = _ref[_i];
    calculate_scores(abbrev);
    calculate_percentages(abbrev);
  }
  _ref1 = gon.green;
  for (type in _ref1) {
    weight = _ref1[type];
    $("#" + type).slider({
      animate: true,
      max: 10,
      min: -10,
      step: .1,
      orientation: "horizontal",
      value: weight,
      slide: function(event, ui) {
        change_green_val(ui.handle.parentElement.id, ui.value);
        return show_map();
      }
    });
    $("#" + type + "_box").on('change', function(eventObject) {
      return change_green_val(this.id.slice(0, -4), this.value);
    });
  }
  $("#time").slider({
    animate: true,
    max: _max,
    min: _min,
    orientation: "horizontal",
    step: 1,
    value: _max,
    slide: function(event, ui) {
      var state, _j, _len1, _ref2;

      $('#year').text("Year: " + ui.value);
      _index = _max - ui.value;
      update_bars();
      _ref2 = gon.state_abbrevs;
      for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
        state = _ref2[_j];
        d3.select("#" + state).attr('fill', fill_color(state));
      }
      return show_map();
    }
  });
  $('#year').text("Year: " + _max + " (change with the slider below)");
  return d3.selectAll('.state').attr('fill', 'white').attr('stroke', 'white').attr('stroke-width', '0.75').on('mouseover', function() {
    bring_to_top(this.id);
    return d3.selectAll("#" + this.id).attr('fill', fill_color(this.id)).transition().duration(200).attr('stroke', 'black').attr('stroke-width', '1.5');
  }).on('mouseleave', function() {
    return d3.selectAll("#" + this.id).attr('fill', fill_color(this.id)).transition().duration(200).attr('stroke', 'white').attr('stroke-width', '0.75');
  }).on('click', function() {
    return make_chart(this.id);
  }).transition().duration(500).delay(function(d, i) {
    return i * 40;
  }).attr('fill', function() {
    abbrev = this.id;
    return fill_color(abbrev);
  });
});
