// Generated by CoffeeScript 1.6.2
var add_axis, add_bars, add_labels, add_legend, add_states, bar_x, bar_y, bring_to_top, calculate_percentages, calculate_scores, change_green_val, chart_group, fill_color, focus_bars, get_absolute, get_chart_data, get_focused, get_labels, get_x_scale, green_scale, height, hide_tooltip, highlight_bars, legend_positions, make_chart, margins, pie_colors, red_scale, setup_chart, show_map, show_tooltip, state_hover, state_unhover, to_compare, toggle_controls, tooltip, tooltip_says, translations, unhighlight_bars, update_bars, width, _index1, _index2, _max, _min, _percentages, _scores, _totals;

green_scale = d3.scale.linear().domain([0, 1]).range(['grey', 'green']);

red_scale = d3.scale.linear().domain([0, 1]).range(['grey', 'red']);

_scores = {};

_percentages = {};

_totals = {};

_max = 2012;

_min = 2001;

_index1 = 0;

_index2 = 0;

margins = {
  top: 50,
  right: 15,
  bottom: 20,
  left: 60
};

width = 959;

height = 593;

pie_colors = void 0;

chart_group = void 0;

tooltip = void 0;

translations = void 0;

to_compare = [];

$(function() {
  var abbrev, type, weight, _i, _len, _ref, _ref1;

  chart_group = d3.select("#chart_group");
  width = d3.select('svg')[0][0].width.baseVal.value;
  height = d3.select('svg')[0][0].height.baseVal.value;
  pie_colors = gon.pie_colors;
  translations = gon.translations;
  _ref = gon.state_abbrevs;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    abbrev = _ref[_i];
    calculate_scores(abbrev);
    calculate_percentages(abbrev);
  }
  _ref1 = gon.green;
  for (type in _ref1) {
    weight = _ref1[type];
    $("#" + type + "_slider").slider({
      animate: true,
      max: 10,
      min: -10,
      step: .1,
      orientation: "vertical",
      value: weight,
      slide: function(event, ui) {
        return change_green_val(ui.handle.parentElement.id.slice(0, -7), ui.value);
      }
    });
    $("#" + type + "_input").on('change', function(eventObject) {
      return change_green_val(this.id.slice(0, -6), this.value);
    });
  }
  $("#time").slider({
    animate: true,
    max: _max,
    min: _min,
    orientation: "horizontal",
    step: 1,
    value: _max,
    slide: function(event, ui) {
      var state, _j, _len1, _ref2, _results;

      $('#year').text("Year: " + ui.value);
      _index1 = _max - ui.value;
      update_bars();
      _ref2 = gon.state_abbrevs;
      _results = [];
      for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
        state = _ref2[_j];
        _results.push(d3.selectAll("#" + state).attr('fill', fill_color(state)));
      }
      return _results;
    }
  });
  $('#year').text("Year: " + _max + " (change with the slider below)");
  d3.selectAll('.state').attr('fill', 'white').attr('stroke', 'white').attr('stroke-width', '0.75').on('mouseover', function() {
    return state_hover(this.id);
  }).on('mouseleave', function() {
    return state_unhover(this.id);
  }).on('click', function() {
    if (to_compare.indexOf(this.id) === -1) {
      to_compare[to_compare.length] = this.id;
    }
    return make_chart();
  }).transition().duration(500).delay(function(d, i) {
    return i * 40;
  }).attr('fill', function() {
    abbrev = this.id;
    return fill_color(abbrev);
  });
  tooltip = d3.select('body').append('div').attr('class', 'tooltip').style('opacity', 0);
  d3.select('body').on('keydown', function() {
    if (d3.event.keyCode === 27) {
      return show_map(false);
    }
  });
  $('#scale_absolute').on('click', update_bars);
  $('#scale_relative').on('click', update_bars);
  to_compare = ['WA', 'FL', 'TX'];
  return make_chart();
});

calculate_scores = function(state) {
  var gigawatts, i, k, scores, state_data, toAdd, totals, v, _i, _ref;

  state_data = gon.elec_data[state];
  scores = [];
  totals = [];
  _max = 0;
  for (k in state_data) {
    v = state_data[k];
    if (typeof v !== typeof "") {
      if (v[0][0] > _max) {
        _max = v[0][0];
      }
      for (i = _i = 0, _ref = v.length; _i < _ref; i = _i += 1) {
        gigawatts = parseFloat(v[i][1]);
        if ($.isNumeric(gigawatts)) {
          if (gigawatts < 0) {

          } else {
            if (!$.isNumeric(scores[i])) {
              scores[i] = 0;
            }
            if (!$.isNumeric(totals[i])) {
              totals[i] = 0;
            }
            toAdd = gon.green[k] * gigawatts;
            scores[i] += toAdd;
            totals[i] += gigawatts;
          }
        }
      }
    }
  }
  _scores[state] = scores;
  return _totals[state] = totals;
};

calculate_percentages = function(state) {
  var i, k, percentage_series, percentages, state_data, totals, v, _i, _ref;

  state_data = gon.elec_data[state];
  totals = _totals[state];
  percentages = {};
  for (k in state_data) {
    v = state_data[k];
    if (typeof v !== typeof "") {
      percentage_series = [];
      for (i = _i = 0, _ref = v.length; _i < _ref; i = _i += 1) {
        percentage_series[i] = v[i][1] / totals[i] * 100;
      }
      percentages[k] = percentage_series;
    }
  }
  return _percentages[state] = percentages;
};

state_hover = function(id) {
  bring_to_top(id);
  return d3.selectAll("#" + id).attr('fill', fill_color(id)).transition().duration(200).attr('stroke', 'black').attr('stroke-width', '1.5');
};

state_unhover = function(id) {
  return d3.selectAll("#" + id).attr('fill', fill_color(id)).transition().duration(200).attr('stroke', 'white').attr('stroke-width', '0.75');
};

change_green_val = function(type, value) {
  var state, _i, _len, _ref, _results;

  $("#" + type + "_slider").slider("value", value);
  $("#" + type + "_input").val(value);
  gon.green[type] = value;
  _ref = gon.state_abbrevs;
  _results = [];
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    state = _ref[_i];
    calculate_scores(state);
    _results.push(d3.selectAll("#" + state).attr('fill', fill_color(state)));
  }
  return _results;
};

fill_color = function(state) {
  var color, scores, totals;

  scores = _scores[state];
  totals = _totals[state];
  if (scores[_index1] > 0) {
    color = green_scale(scores[_index1] / totals[_index1]);
  } else {
    color = red_scale(-scores[_index1] / totals[_index1]);
  }
  return color;
};

bring_to_top = function(id_to_top) {
  d3.selectAll('path').datum(-1);
  d3.select("#" + id_to_top).datum(1);
  return d3.selectAll('path').sort().order();
};

show_map = function(comparing) {
  chart_group.selectAll('g').remove();
  chart_group.selectAll('rect').remove();
  chart_group.selectAll('text');
  d3.select('#close').remove();
  $('#controls').hide();
  d3.select('#compare').remove();
  d3.select('#controls_toggle');
  d3.selectAll('.legend_label').remove();
  d3.selectAll('.bar_label').remove();
  if (!comparing) {
    return to_compare.length = 0;
  }
};

show_tooltip = function() {
  return tooltip.transition().duration(300).style('opacity', 1);
};

tooltip_says = function(text) {
  return tooltip.text(text).style('left', "" + d3.event.pageX + "px").style('top', "" + d3.event.pageY + "px");
};

hide_tooltip = function() {
  return tooltip.transition().duration(300).style('opacity', 0);
};

legend_positions = function(index) {
  var x, y;

  x = 125 * Math.floor(index / 2) + 15;
  y = 25 * (index % 2) + 5;
  return [x, y];
};

highlight_bars = function(focused) {
  var bars, box, label, labels, state_id, text, _i, _len, _results;

  labels = get_labels();
  _results = [];
  for (_i = 0, _len = to_compare.length; _i < _len; _i++) {
    state_id = to_compare[_i];
    _results.push((function() {
      var _j, _len1, _results1;

      _results1 = [];
      for (_j = 0, _len1 = labels.length; _j < _len1; _j++) {
        label = labels[_j];
        bars = d3.select("#" + state_id + "_" + label + "_bar");
        box = d3.select("#" + label + "_box");
        text = d3.select("#" + label + "_label");
        d3.select('#veil').transition().duration(200).attr('opacity', .9);
        if (focused.indexOf(label) > -1) {
          bars.transition().duration(150).attr('opacity', 1);
          box.transition().duration(200).attr('opacity', 1);
          _results1.push(text.transition().duration(200).attr('opacity', 1));
        } else {
          bars.transition().duration(150).attr('opacity', .1);
          box.transition().duration(200).attr('opacity', .2);
          _results1.push(text.transition().duration(200).attr('opacity', .2));
        }
      }
      return _results1;
    })());
  }
  return _results;
};

unhighlight_bars = function() {
  var focused, labels;

  focused = get_focused();
  labels = get_labels();
  if (focused.length > 0) {
    return highlight_bars(focused);
  } else {
    d3.select('#veil').transition().duration(700).attr('opacity', .75);
    d3.selectAll('.legend_box').transition().duration(200).attr('opacity', 1);
    d3.selectAll('.bar').transition().duration(150).attr('opacity', 1);
    return d3.selectAll('.legend_label').transition().duration(200).attr('opacity', 1);
  }
};

update_bars = function() {
  var absolute, data, label, labels, numbers, state_id, x_scale, _i, _len, _results;

  absolute = get_absolute();
  x_scale = add_axis(absolute);
  _results = [];
  for (_i = 0, _len = to_compare.length; _i < _len; _i++) {
    state_id = to_compare[_i];
    data = get_chart_data(state_id, absolute);
    labels = data[0];
    numbers = data[1];
    _results.push((function() {
      var _j, _len1, _results1;

      _results1 = [];
      for (_j = 0, _len1 = labels.length; _j < _len1; _j++) {
        label = labels[_j];
        _results1.push(d3.selectAll("#" + state_id + "_" + label + "_bar").datum(numbers[labels.indexOf(label)]).transition().duration(200).attr('x', function(d, i) {
          return bar_x(numbers, labels.indexOf(label), x_scale);
        }).attr('width', function(d, i) {
          return x_scale(Math.abs(d));
        }));
      }
      return _results1;
    })());
  }
  return _results;
};

toggle_controls = function() {
  var controls;

  controls = $('#controls');
  if (controls.is(':visible')) {
    return controls.hide();
  } else {
    return controls.show();
  }
};

setup_chart = function() {
  chart_group.append('rect').attr('id', 'veil').attr('width', width).attr('height', height).attr('fill', 'white').attr('opacity', '0.75');
  chart_group.append('rect').attr('id', 'top_stuff').attr('width', width).attr('height', margins['top']).attr('fill', 'white').attr('opacity', 0.75);
  add_legend();
  chart_group.append('text').attr('id', 'close').attr('x', 870).attr('y', 580).text("Close").on('click', function() {
    return show_map(false);
  });
  chart_group.append('text').attr('id', 'compare').attr('x', 10).attr('y', 580).text('Compare').attr('font-size', 25).on('click', function() {
    return show_map(true);
  });
  return chart_group.append('text').attr('id', 'controls_toggle').attr('x', 410).attr('y', 580).text('Controls').on('click', toggle_controls);
};

add_legend = function() {
  var color, index, positions, type, x, y, _results;

  index = 0;
  _results = [];
  for (type in pie_colors) {
    color = pie_colors[type];
    positions = legend_positions(index);
    x = positions[0];
    y = positions[1];
    chart_group.append('rect').datum(false).attr('class', 'legend_box').attr('id', "" + type + "_box").attr('fill', color).attr('stroke', 'white').attr('stroke-width', .75).attr('width', 16).attr('height', 16).attr('x', function() {
      return x;
    }).attr('y', function() {
      return y;
    }).on('mouseover', function() {
      return highlight_bars([this.id.slice(0, -4)]);
    }).on('mouseleave', unhighlight_bars).on('click', function() {
      return focus_bars(this.id.slice(0, -4));
    });
    chart_group.append('text').attr('class', 'legend_label').attr('id', "" + type + "_label").text(translations[type]).attr('x', function() {
      return x + 20;
    }).attr('y', function() {
      return y + 13;
    }).attr('font-size', function() {
      var smaller;

      smaller = ['pet_coke', 'pet_liquid', 'other_renew', 'other_gases'];
      if (smaller.indexOf(this.id.slice(0, -6)) > -1) {
        return 12;
      } else {
        return 17;
      }
    }).on('mouseover', function() {
      return highlight_bars([this.id.slice(0, -6)]);
    }).on('mouseleave', unhighlight_bars);
    _results.push(index += 1);
  }
  return _results;
};

add_states = function() {
  return chart_group.selectAll('g').data(to_compare).enter().append('g').attr('id', function(d, i) {
    return d + "_bars";
  });
};

add_axis = function(absolute) {
  var x_scale;

  d3.select('.axis').remove();
  x_scale = get_x_scale(absolute);
  chart_group.append('g').call(d3.svg.axis().scale(x_scale).orient('bottom')).attr('class', 'axis').attr('transform', "translate(" + margins['left'] + ", " + margins['top'] + ")");
  return x_scale;
};

add_bars = function() {
  var absolute, data, labels, numbers, state_id, x_scale, _i, _len, _results;

  absolute = get_absolute();
  x_scale = add_axis(absolute);
  _results = [];
  for (_i = 0, _len = to_compare.length; _i < _len; _i++) {
    state_id = to_compare[_i];
    data = get_chart_data(state_id, absolute);
    labels = data[0];
    numbers = data[1];
    _results.push(d3.select("#" + state_id + "_bars").selectAll('rect').data(numbers).enter().append('rect').attr('class', 'bar').attr('id', function(d, i) {
      return "" + state_id + "_" + labels[i] + "_bar";
    }).attr('y', function(d, i) {
      return bar_y("" + state_id + "_bars");
    }).attr('x', function(d, i) {
      return bar_x(numbers, i, x_scale);
    }).attr('width', function() {
      return 0;
    }).attr('height', 18).attr('fill', function(d, i) {
      return pie_colors[labels[i]];
    }).attr('opacity', 1).on('mouseover', function() {
      return highlight_bars([this.id.slice(3, -4)]);
    }).on('mousemove', function(d, i) {
      return tooltip_says("" + translations[labels[i]] + ": " + (Math.round(d)));
    }).on('click', function() {
      return focus_bars(this.id.slice(3, -4));
    }).on('mouseleave', unhighlight_bars).transition().duration(500).delay(function(d, i) {
      return i * 50;
    }).attr('width', function(d, i) {
      return x_scale(Math.abs(d));
    }));
  }
  return _results;
};

add_labels = function() {
  var state_id, _i, _len, _results;

  _results = [];
  for (_i = 0, _len = to_compare.length; _i < _len; _i++) {
    state_id = to_compare[_i];
    _results.push(chart_group.append('text').attr('id', "" + state_id + "_label").attr('class', 'bar_label').attr('x', 0).attr('y', function() {
      return bar_y("" + state_id + "_bars") + 18;
    }).text("" + state_id));
  }
  return _results;
};

bar_x = function(numbers, i, x_scale) {
  var j, start, _i, _j;

  start = margins['left'];
  if (numbers[i] > 0) {
    for (j = _i = 0; _i < i; j = _i += 1) {
      if (numbers[j] > 0) {
        start += x_scale(numbers[j]);
      }
    }
  } else {
    for (j = _j = 0; _j <= i; j = _j += 1) {
      if (numbers[j] < 0) {
        start += x_scale(numbers[j]);
      }
    }
  }
  return start;
};

get_chart_data = function(state_id, absolute) {
  var labels, numbers, series, to_append, type, _ref, _ref1;

  labels = [];
  numbers = [];
  if (absolute) {
    _ref = gon.elec_data[state_id];
    for (type in _ref) {
      series = _ref[type];
      labels[labels.length] = type;
      to_append = series[_index1][1];
      if (!to_append) {
        to_append = 0;
      }
      numbers[numbers.length] = to_append;
    }
  } else {
    _ref1 = _percentages[state_id];
    for (type in _ref1) {
      series = _ref1[type];
      labels[labels.length] = type;
      numbers[numbers.length] = series[_index1];
    }
  }
  return [labels, numbers];
};

get_labels = function() {
  var labels, trans, type;

  labels = [];
  for (type in translations) {
    trans = translations[type];
    labels[labels.length] = type;
  }
  return labels;
};

get_x_scale = function(absolute) {
  var max, num, numbers, state_id, sum, _i, _j, _len, _len1;

  max = 0;
  for (_i = 0, _len = to_compare.length; _i < _len; _i++) {
    state_id = to_compare[_i];
    sum = 0;
    numbers = get_chart_data(state_id, absolute)[1];
    for (_j = 0, _len1 = numbers.length; _j < _len1; _j++) {
      num = numbers[_j];
      sum += Math.abs(num);
    }
    if (sum > max) {
      max = sum;
    }
  }
  return d3.scale.linear().domain([0, max]).range([0, width - margins['left'] - margins['right']]);
};

bar_y = function(bar_id) {
  var bar_num, g, num_bars, _i, _len, _ref;

  num_bars = 1;
  bar_num = 0;
  _ref = chart_group.selectAll('g')[0];
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    g = _ref[_i];
    if (g.id) {
      if (g.id === bar_id) {
        bar_num = num_bars;
      }
      num_bars += 1;
    }
  }
  return height * bar_num / num_bars;
};

focus_bars = function(type) {
  var box;

  box = d3.select("#" + type + "_box");
  return box.datum(!box.datum());
};

get_focused = function() {
  var box, label, labels, toReturn, _i, _len;

  toReturn = [];
  labels = get_labels();
  for (_i = 0, _len = labels.length; _i < _len; _i++) {
    label = labels[_i];
    box = d3.select("#" + label + "_box");
    if (box.datum()) {
      toReturn[toReturn.length] = label;
    }
  }
  return toReturn;
};

get_absolute = function() {
  return $('#scale_absolute').is(':checked');
};

make_chart = function() {
  setup_chart();
  add_states();
  add_bars();
  return add_labels();
};
